<%- include('partials/header') %>

<div class="d-flex">
    <%- include('partials/sidebar') %>
    <main class="container mt-4">
        <h2 class="mb-4 text-center">Statistike</h2>
        <div class="charts row justify-content-center">
            <div class="col-lg-6 col-md-8 mb-4">
                <h5 class="text-center">Napredek nalog (%)</h5>
                <canvas id="progressChart"></canvas>
            </div>
            <div class="col-lg-6 col-md-8">
                <h5 class="text-center">Stanje nalog</h5>
                <canvas id="tasksChart"></canvas>
            </div>
        </div>
    </main>
</div>

<%- include('partials/footer') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const tasksResponse = await fetch('/api/tasks');
            const tasks = await tasksResponse.json();

    
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const inProgressTasks = tasks.filter(task => task.status === 'in-progress').length;
            const toDoTasks = tasks.filter(task => task.status === 'pending').length;

            const progressData = {
                labels: ["Zaključene", "V teku", "Prihajajoče"],
                datasets: [{
                    label: "Status nalog",
                    data: [completedTasks, inProgressTasks, toDoTasks],
                    backgroundColor: ["#4caf50", "#ff9800", "#f44336"],
                    borderColor: ["#4caf50", "#ff9800", "#f44336"],
                    borderWidth: 1
                }]
            };

            new Chart(
                document.getElementById("tasksChart"),
                {
                    type: "doughnut",
                    data: progressData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: "bottom"
                            }
                        }
                    }
                }
            );

            const months = ["Januar", "Februar", "Marec", "April", "Maj", "Junij", "Julij", "Avgust", "September", "Oktober", "November", "December"];

            const tasksByMonth = months.map((month, index) => {
                const startOfMonth = new Date(2025, index, 1);
                const endOfMonth = new Date(2025, index+1, 0);

                const monthlyTasks = tasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    return dueDate >= startOfMonth && dueDate <= endOfMonth;
                });

                return monthlyTasks.length;
            });

            const progressChartData = {
                labels: months,
                datasets: [{
                    label: "Skupno število nalog po mesecih",
                    data: tasksByMonth,
                    backgroundColor: "rgba(54, 162, 235, 0.2)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 2,
                    tension: 0.3,
                }]
            };

            new Chart(
                document.getElementById("progressChart"),
                {
                    type: "line",
                    data: progressChartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: "top",
                            },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "Število opravil"
                                }
                            }
                        }
                    }
                }
);
        } catch (error) {
            console.error("Napaka pri nalaganju opravil: ", error);
        }
    });
</script>
